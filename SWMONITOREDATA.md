# ProwseBox Data

- [swstrancohomes](#swstrancohomes): service workers APIs, DOM resources, navigated URLs, etc.
- [mitmswstrancohomes](#mitmswstrancohomes): service workers APIs when DOM is not present
- [swscontent](#swscontent): service workers codes
- [importedscripts](#importedscripts): additional codes imported by service workers
- [webmanifests](#webmanfiests): web manifests fetched by browsers
- [webworkers](#webworkers): dedicated and shared workers loaded by web pages
- [documents](#documents): security headers in top-level navigation pages


## swstrancohomes
The items in this folder are data collected and stored by the automation tool. When the `offline` mode is enabled, the item specifically ends with `.offline`. The way the offline mode works it to take the list of URLs navigated during the coverage phase, and navigate them again, and collect and store the data. 

```javascript
[ pagesVisited, requestInformations, responseInformations, swsRegs, '', swsData, swsScopes, swsClients, cacheStorage, cookiesStore, swsDuplicates, xData, pagesLinks, pagesVisitedOffline, domInfos, domInfosOffline, pagesLinksOffline, coveragePages ]
```

This is an **array**: we name the items (they refer to the names of the variables used to store the parts of the data at runtime) to aid the description that follows. The data is JSON-stringified before storage. 

### pagesVisited
Object literal associating a URL to be navigated to its final URL navigated. The special `error` value indicates an error during URL navigation (i.e. timeout, certificate issue, etc.)
```json
{
    "http://twitter.com": "https://twitter.com/",
    "http://google.com": "https://www.google.com/",
    "http://example.com": "error"
}
```

### requestInformations
An object literal associating requests URLs to their headers. The entries in this object follow the schema 
```json
{
    "top_frame1": {
        "requestType1": {
            "requestURL1": {
                "headername1": "headervalue1",
                "headername2": "..."
            },
            "requestURL2": { ... }
        }, 
        "requestType2": { ... }
    },
    "top_frame2": { ... }
}
```
where:
- `top_frame`: is the parent frame initiating a request. For top navigations tabs, this value is `about:blank`, or `null`, etc. For iframes and subresources (i.e. scripts, images), the `top_frame` is the URL of the page initiating embedding the iframe or loading the subresource
- `requestType`: is the type of the request, i.e. `document`, `image`, `script`. Slight differences may be observed depending on the automation tool used: [Puppeteer/Playwright](https://playwright.dev/docs/api/class-request#request-resource-type), or a [browser extension](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest/ResourceType).
- `requestURL`, `headername` and `headervalue` are self-explanatory
  
Dumping the headers of all requests can take a lot of space. To avoid that, by default we only log requests of type `document`. The[requestypes](CONFIG.md#requestypes) configuration option can be adjusted to the types of requests to be logged.

### responseInformations
This object contains response headers. The structure is similar to [requestsInformation](#requestinformations). 

### swsRegs
An object holding information about service workers registrations. It structure is as follows:
```javaScript
{
    "urls": {
        "serviceworkerURL1": "",
        "serviceworkerURL2": "",
        "..."
    },
    "aurls": {
        "serviceworkerURL1": {
            "pageURL1": "",
            "pageURL2": "",
            "...": "",
        }
    },
    "errors": {
        "errormessage1": "",
        "errormessage2": "",
    },
    "updates": [], 
    "versions": [], 
    "swr": {
         "errormessage1": "",
        "errormessage2": "",
        "..."
    },
    "prb": {
        "errormessage1": "",
        "errormessage2": "",
        "..."
    },
    
    "coverage": {}
}
```
- `urls`  holds the list of registered service workers URLs. 
- `aurls` further associates a service worker URL to the URLs of pages where it [registration is initiated](https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerContainer/register).
- `errors`: collects errors reported by when the [ServiceWorker domain](https://chromedevtools.github.io/devtools-protocol/tot/ServiceWorker/) of Chrome Devtools Protocol (CDP) is enabled with [Puppeteer](https://pptr.dev) or [Playwright](https://playwright.dev)  as automation tools. The `errors` can be a very important source of information for developers tracking errors in their service workers.
- `updates` and `versions` are additional information provided by the ServiceWorker domain about service workers updates and versions. We have removed this information from the logs. We may consider adding them via a configuration option
- `swr` and `prb` are similar to `errors` but holds logs generated by the [swebRequest](https://github.com/sqwr/swebrequest) [setup](CONFIG.md#setup)
- `coverage` was an unsuccessfull attempt to collect service workers coverage information with [Istanbul](https://istanbul.js.org/): may be added in the future


### swsData
This object contains the monitored service workers events and APIs calls. It general structure is as follows:
```javaScript
{
    "serviceworkerURL1": {
        "datasize1": {
            "loc": { 
                "origin": "serivceworkerOrigin", 
                "href": "serviceworkerURL", 
                "scope": "serviceworkerScope", 
                "scriptURL": "serviceworkerURL" 
            },
            "clients": { 
                "pageURL1": "", 
                "..." 
            },
            "data": [ datum1, datum2, ...]
        },
        "datasize2": { ... },
        "..."
    },
    "serviceworkerURL2": { ... },
    "..."
}
```
The structure of `datum$i` is described in [service workers apis logs structure](SWHOOKING.md#collected-data-structure)
The reason why we grouped the collected data by `datasize` was to avoid duplicates, i.e. avoid logging the same API call again and again (i.e. `IndexedDB.open`)

### swsScopes
An object listing service workers scopes (fully qualified URLs)
```json
{
    "scopeURL1": "",
    "scopeURL2": "",
    "..."
}
```

### swsClients
An object associating service workers scopes (fully qualified URLs) to the clients (pages) under that scope
```json
{
    "scopeURL1": {
        "pageURL1": "",
        "pageURL2": "",
    },
    "scopeURL2": { ... },
    "..."
}
```

### cacheStorage
An object associated an origin to the resources found in the origin's cache. 
```javascript
{
    "origin1": {
        "resourceURL1": [ request, response ]
        "resourceURL2": { ... },
        "..."
    },
    "origin2": { ... },
    "..."
}
```
where request and response objects are serialized as in [sws hooking logs](SWHOOKING.md#collected-data-structure)

### CookieStore
An object associated set cookies to their domains, names and values
```javascript
{
    "domain1": {
        "cookieName1": {
            "cookieValue1": {
                domain: "domain1",
                name: "cookieName1",
                value: "cookieValue1",
                httpOnly: boolean,
                hostOnly: boolean,
                path: string,
                expirationDate: float,
                sameSite: string,
                secure: boolean,
                session: boolean,
                storeId: string
            },
            "..."
        },
        "cookieName2": { ... }
    },
    "domain2": { ... }
}
```
Note that the information associated to each cookie may vary depending on the browser, and the automation tool. The example above is collected by a Chrome extension. 


### swsDuplicates
This object is usually empty. It is only set when Puppeteer/Playwright with Chromium browsers. 
```javascript
{
    "serviceworkerURL1": {
        description: {
            "datasize1": number,
            "datasize2": number,
            "..."
        }
    },
    "serviceworkerURL2": { ... },
    "..."
}
```
It associates each service worker API `description` to the number of time the API has been logged (with a specific log size: the log size is the JSON string size of the log).

### xData
This entry is there for compatibility reasons. Its purpose was to hold data collected from browser extensions monitoring. 
In the current version of the framework, this object is empty

### pagesLinks
This object associates origin to a list of same-origin URLs found on different navigated pages
```json
{
    "origin1": {
        "pageURL1": "",
        "pageURL2": "",
        "..."
    },
    "origin2": { ... },
    "..."
}
```

### pagesVisitedOffline
This object is most of the times empty, and has been kept for compatibility reasons. It was added to hold URLs that are navigated when the browser was taken offline to test how service workers behave in this network condition. This object is no more useful because the offline mode of service workers is tested via an independent run of the framework. For this run, the related [pagesVisited](#pagesvisited) object will contain the information of pages that was successfully navigated when the browser is offline

### domInfos
This object associates navigated top-level URLs to various information extracted from their DOMs. The snapshot of the DOM is taken multiple times (every 15 seconds)
```javascript
{
    "pageURL1": [ {
        resources: {
            link: { linkURL1: "", ...}, // the values referenced by the ["href", "prefetch", 'alternate', 'next', 'prerender', 'prev'] attributes of the <link> tag
            iframe: { iframeURL1: "", ... }, // the values referenced by the src attribute of <iframe> tags
            script: { scriptURL1: "", ...}, // the values referenced by the src attribute of <script> tags
            img: { imageURL1: "", ... }, // the values referenced by the src and srcset attribute of <img> tags
            a: { anchorURL1: "", ...}, // values referenced by the ["href", "ping"] attributes of the <a> tags
            as: { // values referenced by the src attribute of <a> tags, associated to the values of the target, ref, referrerpolicy and ping attributes
                anchorURL1: {
                    target: string,
                    rel: string,
                    referrerpolicy: string,
                    ping: string
                }
            },
            audio: { audioURL1: "", ...},  // values referenced by the src attribute of the <audio> tags
            video: { videoURL1: "", ...}, // values referenced by the src and poster attributes of the <video> tags
            source: { sourceURL1: "", ...}, // values referenced by the src and srcset attributes of the <source> tags
            track: { trackURL1: "", ...}, // values referenced by the src attribute of the <track> tags
        },
        location: { 
            href: "pageURL1",
            origin: "pageOrigin",
            domain: "pageDomain"
        },
        register: [ argsList1, ... ], // service worker registrations arguments
        dworkers: [ argsList1, ... ], // spawn dedicated workers arguments
        shworkers: [ argsList1, ... ], // spawn shared workers arguments
        registrations: [ 
            {
                "registeredServiceWorkerScopeURL1": "registeredServiceworkerURL1", ...
            }, 
            [ argsList1 ], // service workers registrations arguments 
            "pageURL1", 
            {
                "registeredServiceWorkerScopeURL1": "registeredServiceworkerURL1", ...
            }, 
            [ pushsubscription1, ...], // each item is an element of reg.pushManager.getSubscription()
        ],
        pushsubscribe: [ argsList1, ... ], // calls to PushManager.subscribe 
        pushsubscriptions: [ pushsubscription1, ...], // each item is an element of reg.pushManager.getSubscription()
        notifications: [ argsList1, ... ], // calls to Notifications.requestPermission()
        manifest: {
            "manifestURL1": boolean // the value of the boolean indicates if the manifest is fetched with credentials included (true) or omitted (false)
        },
        metacsps: [ csp1, ...], // content security policies included in the DOM
        domsize: number, // the size in bytes of the DOM: document.body.parentElement.outerHTML
        domhash: string, // the fuzzy has of the DOM (using ssdeep)
        compatibility: string // caches accesses performed directly from web pages
    }, ...],
    "pageURL2": { ... },
    "..."
}
```


### domInfosOffline
This object was meant to contain [dominfos](#dominfos) when testing service workers offline mode. But it is no more used, and defaults to the empty object

### pagesLinksOffline
This object was meant to contain [pageLinks](#pageslinks) when testing service workers offline mode. But it is no more set, and defaults to the empty object

### coveragePages
An array containing the list of in-scope pages URLs navigated when the coverage phase is enabled. It is this list of URLs which is used during the separate offline phase in order to assess service workers which work when the user is offline


## mitmswstrancohomes
This folder stores additional (potentially duplicates) service workers APIs logs. This is particularly indicated for events occuring while the service worker does not have any page client to [broadcast](SWHOOKING.md#BroadcastChannel) the logs to. The structure of the information stored in this folder is [described here](#swsdata): the nested part under the `datasize$i` sections.

## swscontent
The folder `swscontent` is written by the [service worker hooker](SWHOOKING.md), i.e. Mitmproxy or an extension. Each item within this folder is a JSON string with the following fields:
- `url`: the service worker URL
- `purl`: the URL of the page that triggered the service worker registration/update. 
- `body`: the service worker code
- `response`: the service worker response headers, mostly only security related headers
```json
[
    "content-security-policy",
    "content-security-policy-report-only",
    "feature-policy",
    "x-frame-options",
    "x-content-security-policy",
    "x-content-security-policy-report-only",
    "cross-origin-embedder-policy",
    "cross-origin-opener-policy",
    "cross-origin-resource-policy",
    "x-content-type-options",
    "permissions-policy",
    "service-worker-allowed",
    "content-type"
]
```
- `request`: request headers, mostly security headers.
```json
[
    "referrer-policy",
    "referer-policy",
    "report-to",
    "referer"
]
```
Note that item in this folder may be duplicates, i.e. same service worker being registered multiple times: this choice was made for performance reasons, as well as to avoid race conditions (as multiple Mitmproxy instances may be writing the `swscontent` folder) and finally because we did not have storage constraints (the overhead of storing the same service workers code multiple times is negligible) we do not perform checks on previous. 

> **Note**
> Set [swscontent](CONIFG.md#swscontent) to `true` in order to enable the logging of service workers code


## importedscripts
The folder `importedscripts` contains additional scripts imported by service workers. Its structure is similar to that of the [swscontent](#swscontent) above:
- `url`: the imported script URL
- `body`: the imported script body
- `swurl`: the service worker in which the script is imported and executed, i.e. the value of the `referer` header.
- `request`: the imported scripts request headers
- `response`: the imported scripts response headers

Note that the items are likely duplicated. In particular, scripts that are imported by different service workers will be logged as many times as necessary.

To ensure that the `referer` header of imported scripts is present and correspond to the whole service worker URL, we (re)set the [Referrer-Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy) header of service workers to `unsafe-url`. This is only done when the logging of imported scripts is enabled. 

> **Note**
> Set [importedscripts](CONIFG.md#importedscripts) to `true` in order to enable the logging of imported scripts codes


## webmanfiests
The folder `webmanifests` contains the content of [web manifests](https://developer.mozilla.org/en-US/docs/Web/Manifest) resources. Browsers typically downloads the content of the manifest to extract information that will be presented to the user willing to install the web app as a [PWA](https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps). The structure of the information saved in this folder include:
- `url`: the web manfiest URL
- `body`: the web manifest body (This is a JSON file)
- `request`: the web manifest request headers
- `response`: the web manifest response headers
- `purl`: the page that included the web manifest
  
> **Note**
> Set [webmanifests](CONIFG.md#webmanifests) to `true` in order to enable the logging of web manifests content

> **Warning**
> There is a folder named `manifests` which contains manifest files required when automation is done with an extension. They are not to be confused. 


## webworkers
This folder contains [shared](https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker) and [dedicated](https://developer.mozilla.org/en-US/docs/Web/API/Worker) workers codes. Each item is a JSON file with the following fields:
- `url`: the URL of the worker
- `purl`: the page that spawned the worker
- `wtype`: the type of worker: `worker` or `sharedworker`
- `request`: filtered request headers
- `response`: filtered response headers

> **Note**
> Set [webworkers](CONIFG.md#webworkers) to `true` in order to enable the logging of web workers content

## documents
This folder contains filtered (security) headers of top-level navigations (HTML documents). Each item is a JSON file with the following fields:
- `url`: the page URL
- `request`: the filtered request headers
- `response`: the filtered response headers

